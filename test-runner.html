<link rel="import" href="../polymer/polymer.html">

<dom-module id="test-runner">
    <template>
        <content id="testRunnerContent">
        </content>

        <button on-click="runTests">Run tests</button>

        <br>
        <br>

        <template is="dom-repeat" items="[[testComponents]]">
            <div><input id="[[item.localName]]-should-run-input" type="checkbox" on-change="componentShouldRunInputChanged"> [[item.localName]]: # inputs to generate <input id="[[item.localName]]-num-tests-input" type="number" on-input="componentNumTestsInput"></div>
            <template is="dom-repeat" items="[[item.tests]]">
                <div><input id="[[replaceSpaces(item.description)]]-should-run-input" type="checkbox"> [[item.description]]: # inputs to generate <input id="[[replaceSpaces(item.description)]]-num-tests-input" type="number"></div>
            </template>
        </template>
    </template>

    <script>
        class TestRunner {
            beforeRegister() {
                this.is = 'test-runner';
            }

            replaceSpaces(string) {
                return string.split(' ').join('-');
            }

            componentShouldRunInputChanged(event) {
                const localName = event.target.id.replace('-should-run-input', '');
                const testComponent = this.testComponents.find((testComponent) => {
                    return testComponent.localName === localName;
                });
                testComponent.tests.forEach((test) => {
                    this.querySelector(`#${this.replaceSpaces(test.description)}-should-run-input`).checked = event.target.checked;
                });
            }

            componentNumTestsInput(event) {
                const localName = event.target.id.replace('-num-tests-input', '');
                const testComponent = this.testComponents.find((testComponent) => {
                    return testComponent.localName === localName;
                });
                testComponent.tests.forEach((test) => {
                    this.querySelector(`#${this.replaceSpaces(test.description)}-num-tests-input`).value = event.target.value;
                });
            }

            //TODO figure out the idiomatic way to access the "light DOM" children in Polymer 2 or just plain custom elements once we upgrade this to the V1 specs
            attached() {
                this.testComponents = this.getContentChildren('#testRunnerContent').map((testComponent) => {
                    testComponent.prepareTests((description, test) => {
                        testComponent.tests = [...(testComponent.tests || []), {
                            localName: testComponent.localName,
                            description,
                            test
                        }];
                    });
                    return testComponent;
                });
            }

            runTests() {
                this.testComponents.forEach((testComponent) => {
                    testComponent.tests.forEach((test) => {
                        const shouldRun = this.querySelector(`#${this.replaceSpaces(test.description)}-should-run-input`).checked;
                        if (shouldRun) {
                            const numTests = this.querySelector(`#${this.replaceSpaces(test.description)}-num-tests-input`).value;
                            test.test(test.description, numTests);
                        }
                    });
                });
            }
        }

        Polymer(TestRunner);
    </script>
</dom-module>
