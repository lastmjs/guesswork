<link rel="import" href="../polymer/polymer.html">

<dom-module id="test-runner">
    <template>
        <content id="testRunnerContent">
        </content>

        <button on-click="runTests">Run tests</button>

        <br>
        <br>

        <template is="dom-repeat" items="[[testComponents]]">
            <div><input id="[[getShouldRunInputId(item.localName)]]" type="checkbox" on-change="componentShouldRunInputOnChanged" checked$="[[item.shouldRunValue]]"> [[item.localName]]: # inputs to generate <input id="[[getNumTestsInputId(item.localName)]]" type="number" on-input="componentNumTestsInputOnInput" value="[[item.numTestsValue]]"></div>
            <template is="dom-repeat" items="[[item.tests]]">
                <div><input id="[[getShouldRunInputId(item.description)]]" type="checkbox" on-change="testShouldRunInputOnChanged" checked$="[[item.shouldRunValue]]"> [[item.description]]: # inputs to generate <input id="[[getNumTestsInputId(item.description)]]" type="number" on-input="testNumTestsInputOnInput" value="[[item.numTestsValue]]"></div>
            </template>
        </template>
    </template>

    <script>
        class TestRunner {
            beforeRegister() {
                this.is = 'test-runner';
            }

            getLocalNameFromShouldRunInputId(id) {
                return id.replace('-should-run-input', '');
            }

            getLocalNameFromNumTestsInputId(id) {
                return id.replace('-num-tests-input', '');
            }

            replaceSpaces(string) {
                return string.split(' ').join('-');
            }

            getShouldRunInputId(string) {
                return `${this.replaceSpaces(string)}-should-run-input`;
            }

            getNumTestsInputId(string) {
                return `${this.replaceSpaces(string)}-num-tests-input`;
            }

            componentShouldRunInputOnChanged(event) {
                window.localStorage.setItem(event.target.id, event.target.checked);
                const localName = this.getLocalNameFromShouldRunInputId(event.target.id);
                const testComponent = this.testComponents.find((testComponent) => {
                    return testComponent.localName === localName;
                });
                testComponent.tests.forEach((test) => {
                    const shouldRunInput = this.querySelector(`#${this.getShouldRunInputId(test.description)}`);
                    shouldRunInput.checked = event.target.checked;
                    shouldRunInput.dispatchEvent(new Event('change'));
                });
            }

            testShouldRunInputOnChanged(event) {
                window.localStorage.setItem(event.target.id, event.target.checked);
            }

            componentNumTestsInputOnInput(event) {
                window.localStorage.setItem(event.target.id, event.target.value);
                const localName = this.getLocalNameFromNumTestsInputId(event.target.id);
                const testComponent = this.testComponents.find((testComponent) => {
                    return testComponent.localName === localName;
                });
                testComponent.tests.forEach((test) => {
                    const numTestsInput = this.querySelector(`#${this.getNumTestsInputId(test.description)}`);
                    numTestsInput.value = event.target.value;
                    numTestsInput.dispatchEvent(new Event('input'));
                });
            }

            testNumTestsInputOnInput(event) {
                window.localStorage.setItem(event.target.id, event.target.value);
            }

            //TODO figure out the idiomatic way to access the "light DOM" children in Polymer 2 or just plain custom elements once we upgrade this to the V1 specs
            attached() {
                this.testComponents = this.getContentChildren('#testRunnerContent').map((testComponent) => {
                    testComponent.shouldRunValue = window.localStorage.getItem(this.getShouldRunInputId(testComponent.localName)) === 'true' ? true : false;
                    testComponent.numTestsValue = window.localStorage.getItem(this.getNumTestsInputId(testComponent.localName));
                    testComponent.prepareTests((description, test) => {
                        testComponent.tests = [...(testComponent.tests || []), {
                            localName: testComponent.localName,
                            description,
                            test,
                            shouldRunValue: window.localStorage.getItem(this.getShouldRunInputId(description)) === 'true' ? true : false,
                            numTestsValue: window.localStorage.getItem(this.getNumTestsInputId(description))
                        }];
                    });
                    return testComponent;
                });
            }

            runTests() {
                this.testComponents.forEach((testComponent) => {
                    testComponent.tests.forEach((test) => {
                        const shouldRun = this.querySelector(`#${this.getShouldRunInputId(test.description)}`).checked;
                        if (shouldRun) {
                            const numTests = this.querySelector(`#${this.getNumTestsInputId(test.description)}`).value;
                            const tape = require('tape');
                            delete require.cache[require.resolve('tape')]; //this is necessary so that tape will run tests fresh each time. Apparently it keeps some state around that does not let the tests run multiple times
                            test.test(tape, test.description, numTests);
                        }
                    });
                });
            }
        }

        Polymer(TestRunner);
    </script>
</dom-module>
